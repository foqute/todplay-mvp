<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1400, user-scalable=no" />
<title>TOD play – Fixed MVP</title>
<style>
  /* ===== 고정 레이아웃 치수 ===== */
  :root{
    --w-sidenav: 120px;          /* 맨 왼쪽 세로 메뉴 */
    --w-left:   360px;           /* 업로드 및 옵션 패널 */
    --w-right:  380px;           /* 피드백 패널 */
    --gap:      24px;
    --stage-w:  990px;           /* 가운데 작업 캔버스 가로 */
    --stage-h:  680px;           /* 가운데 작업 캔버스 세로 */
    --bg: #0e1217; --panel:#141a22; --panel2:#10151c; --txt:#dbe3ee; --muted:#96a2b3;
    --line:#2a3542; --line2:#334254; --blue:#2f7df4; --blue2:#4aa1ff; --chip:#1b2430; --chipOn:#2a3b51;
  }
  *{box-sizing:border-box} html,body{height:100%;background:var(--bg);color:var(--txt);margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .page{
    width: calc(var(--w-sidenav) + var(--w-left) + var(--gap) + var(--stage-w) + var(--gap) + var(--w-right));
    min-height: calc(var(--stage-h) + 120px);
    margin: 24px auto;
    display: grid;
    grid-template-columns: var(--w-sidenav) var(--w-left) var(--stage-w) var(--w-right);
    grid-template-rows: auto;
    column-gap: var(--gap);
    align-items: start;
  }
  .card{background:var(--panel); border:1px solid var(--line); border-radius:10px; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset}
  .label{display:block; font-weight:700; margin:10px 12px 6px; color:#cfe2ff}
  .sub{color:var(--muted); font-size:12px; margin:0 12px 10px}
  .btn{background:#1a2633; border:1px solid var(--line2); color:#eaf2ff; padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn.primary{background: linear-gradient(90deg, var(--blue), var(--blue2)); border:none; color:white; font-weight:700}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); border:1px solid var(--line2); padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none}
  .chip.on{background:var(--chipOn); border-color:#446086}
  .row{display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .hint{color:#9fb1c6; font-size:12px; text-align:center}

  /* ===== 사이드 내비 ===== */
  .sidenav{grid-column:1; position:sticky; top:24px}
  .brand{display:flex; gap:8px; align-items:center; margin-bottom:14px; padding:10px; border-radius:10px}
  .brand img{width:22px; height:22px}
  .brand b{letter-spacing:.2px}
  .navbtn{display:block; width:100%; padding:10px 8px; margin-bottom:8px; background:var(--panel); border:1px solid var(--line); color:var(--txt); border-radius:10px; text-align:center; cursor:pointer}
  .navbtn:hover{border-color:#3b4a5f}

  /* ===== 왼쪽 옵션 패널 ===== */
  .left{grid-column:2; display:flex; flex-direction:column; gap:14px}
  .store, .learn{padding:10px 10px 12px}
  .drop{padding:12px}
  .dz{
    height:140px; background:var(--panel2); border:2px dashed #3a4a5e; border-radius:12px; display:grid; place-items:center; color:#b9c7d9
  }
  .dz input{display:none}
  .dz .dz-tip{pointer-events:none}
  .opts{padding:12px}
  .opts .grp{margin:8px 0 12px}
  .opts .grp .title{font-weight:700; margin-bottom:6px}
  .optrow{display:flex; gap:8px; flex-wrap:wrap}
  .radio{background:var(--chip); border:1px solid var(--line2); border-radius:8px; padding:6px 10px; cursor:pointer}
  .radio input{display:none}
  .radio.on{background:var(--chipOn); border-color:#466189}
  .run{margin-top:8px; display:flex; justify-content:stretch}
  .run .btn{flex:1; padding:12px}

  /* ===== 가운데 스테이지(고정 크기) ===== */
  .stageWrap{grid-column:3; position:relative; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px}
  #stage{display:block; width:var(--stage-w); height:var(--stage-h); background:#fff; border-radius:12px}

  /* ===== 오른쪽 피드백 패널 ===== */
  .right{grid-column:4; display:flex; flex-direction:column; gap:10px}
  .right .hd{display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:var(--panel); border:1px solid var(--line)}
  .score{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:10px; min-height:44px}
  .notes{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px; min-height:360px; overflow:auto}
  .chat{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center}
  .chat input{flex:1; background:#0f151c; border:1px solid var(--line2); border-radius:8px; padding:10px; color:var(--txt)}
  .ico{width:36px; height:36px; border-radius:10px; background:#1a2430; border:1px solid var(--line2); color:#dbe6ff; display:grid; place-items:center; cursor:pointer}

  /* 세세한 보정 */
  .ver{color:#9eb2c9; font-size:12px}
  .card-title{font-weight:700; margin:4px 0 8px 2px}
</style>
</head>
<body>

<div class="page">

  <!-- 좌측 세로 메뉴 -->
  <aside class="sidenav">
    <div class="brand">
      <img src="logo.png" alt="">
      <b>TOD play</b>
    </div>
    <button class="navbtn">가이드</button>
    <button class="navbtn">탐색</button>
    <button class="navbtn">구독</button>
    <button class="navbtn">비즈니스</button>
  </aside>

  <!-- 업로드 + 옵션 패널 -->
  <section class="left">

    <div class="card store">
      <span class="label">자료 데이터 저장소</span>
      <p class="sub">자료를 저장하고 불러올 수 있습니다</p>
    </div>

    <div class="card learn">
      <span class="label">학습 데이터 저장소</span>
      <p class="sub">학습용 레퍼런스를 입력해 빠르게 불러올 수 있습니다</p>
    </div>

    <div class="card drop" id="ref-box">
      <div class="card-title">원본 이미지</div>
      <label class="dz" id="ref-dz">
        <input id="ref" type="file" accept="image/*">
        <div class="dz-tip">파일 선택 또는 드래그&드롭<br>(끊어오기 가능)</div>
      </label>
    </div>

    <div class="card drop" id="stu-box">
      <div class="card-title">실습 이미지</div>
      <label class="dz" id="stu-dz">
        <input id="stu" type="file" accept="image/*">
        <div class="dz-tip">파일 선택 또는 드래그&드롭<br>(끊어오기 가능)</div>
      </label>
    </div>

    <div class="card opts">
      <div class="grp">
        <div class="title">학습 유형 선택</div>
        <div class="optrow" id="modes">
          <label class="radio on"><input type="radio" name="mode" value="copy" checked>모작</label>
          <label class="radio"><input type="radio" name="mode" value="style">스타일 모작</label>
          <label class="radio"><input type="radio" name="mode" value="orig">창작</label>
        </div>
      </div>
      <div class="grp">
        <div class="title">평가 항목 선택</div>
        <div class="chips" id="chips">
          <div class="chip on"  data-k="형태">형태</div>
          <div class="chip on"  data-k="명암">명암</div>
          <div class="chip"      data-k="색감">색감</div>
          <div class="chip"      data-k="투시">투시</div>
          <div class="chip"      data-k="구도">구도</div>
        </div>
      </div>
      <div class="run"><button id="btn-run" class="btn primary">분석 시작</button></div>
    </div>

  </section>

  <!-- 가운데 캔버스(고정 크기) -->
  <section class="stageWrap card">
    <canvas id="stage" width="990" height="680"></canvas>
  </section>

  <!-- 오른쪽 피드백 -->
  <aside class="right">
    <div class="hd">
      <div><b>피드백 로그</b></div>
      <div class="ver">v0.2 MVP</div>
    </div>
    <div id="score" class="score"></div>
    <div id="notes" class="notes">아직 분석을 시작하지 않았습니다. 좌측에서 이미지를 올리고 ‘분석 시작’을 눌러 주세요.</div>
    <div class="chat">
      <input id="ask" placeholder="의문점이 있으면 여기에 질문하세요" />
      <div class="ico" title="음성">🎤</div>
      <div class="ico" title="전송">➤</div>
    </div>
  </aside>

</div>

<script>
/* ========== 작은 유틸 ========== */
const $ = s => document.querySelector(s);

/* 라디오/칩 토글 UI */
for (const r of document.querySelectorAll('.radio')) {
  r.addEventListener('click', () => {
    document.querySelectorAll('.radio').forEach(x=>x.classList.remove('on'));
    r.classList.add('on');
    r.querySelector('input').checked = true;
  });
}
for (const c of document.querySelectorAll('.chip')) {
  c.addEventListener('click', ()=>c.classList.toggle('on'));
}

/* 드래그&드롭 업로더 */
function wireDrop(labelEl, inputEl){
  ['dragenter','dragover'].forEach(ev=>labelEl.addEventListener(ev, e=>{e.preventDefault();labelEl.style.borderColor='#66a3ff'}));
  ['dragleave','drop'].forEach(ev=>labelEl.addEventListener(ev, e=>{e.preventDefault();labelEl.style.borderColor='#3a4a5e'}));
  labelEl.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files?.[0];
    if(f){ inputEl.files = e.dataTransfer.files; }
  });
}
wireDrop($('#ref-dz'), $('#ref'));
wireDrop($('#stu-dz'), $('#stu'));

/* 캔버스 그리기(오버레이 미리보기용) */
const stage = $('#stage'), ctx = stage.getContext('2d');
function drawOverlay(src){
  if(!src) return;
  const img = new Image();
  img.onload = ()=>{
    ctx.clearRect(0,0,stage.width,stage.height);
    // 가운데 맞춰 contain
    const sw = stage.width, sh = stage.height;
    const rs = Math.min(sw/img.width, sh/img.height);
    const dw = Math.round(img.width*rs), dh = Math.round(img.height*rs);
    const dx = Math.floor((sw-dw)/2), dy = Math.floor((sh-dh)/2);
    ctx.drawImage(img, dx, dy, dw, dh);
  };
  img.src = src;
}

/* 백엔드 연동(기존 포맷 유지) */
$('#btn-run').addEventListener('click', async ()=>{
  const score  = $('#score');
  const notes  = $('#notes');
  score.textContent = '평가 중…';

  // 선택값 모으기
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const aspects = [...document.querySelectorAll('.chip.on')].map(c=>c.dataset.k);

  // 파일
  const rf = $('#ref').files[0];
  const sf = $('#stu').files[0];
  if(!rf && !sf){ notes.textContent='원본/실습 이미지 중 최소 1개는 선택해 주세요.'; score.textContent=''; return }

  // 폼
  const form = new FormData();
  if(rf) form.append('ref', rf, rf.name || 'ref.jpg');
  if(sf) form.append('stu', sf, sf.name || 'stu.jpg');
  form.append('mode', mode);
  form.append('aspects', JSON.stringify(aspects));

  try{
    const res = await fetch('http://127.0.0.1:8000/analyze', {method:'POST', body:form});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    // 점수 필 Pills
    score.innerHTML='';
    (data.scores||[]).forEach(s=>{
      const pill = document.createElement('span');
      pill.style.cssText='display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:999px;background:#1b2430;border:1px solid #2f3d52;font-weight:700';
      pill.textContent = `${s.name} ${Math.round(s.value)}점`;
      score.appendChild(pill);
    });

    // 텍스트 피드백
    notes.innerHTML = (data.feedback||[]).map(t=>`<div style="margin:8px 0;padding:10px;border:1px solid #2b394b;border-radius:8px;background:#0f151c">${t}</div>`).join('') || '피드백 없음';

    // 오버레이 미리보기
    if(data.overlay){ drawOverlay(data.overlay); }

  }catch(e){
    console.warn(e);
    score.textContent='';
    notes.innerHTML = '<div class="muted">백엔드에 연결되지 않았거나 오류가 발생했습니다.</div>';
  }
});
</script>
</body>
</html>
