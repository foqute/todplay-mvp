<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TOD play â€“ MVP</title>
<style>
  :root{
    /* ì–´ë‘ìš´ í†¤ & í¬ì»¤ìŠ¤ ì»¬ëŸ¬ (ì•½ê°„ ë” ê¹Šê³  ì„ ëª…í•˜ê²Œ ì¡°ì •) */
    --bg:#0a0b0d; --panel:#111318; --muted:#98a1aa; --text:#e9edf2;
    --accent:#6aa0ff; --accent-2:#7ee0ff;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#23262d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Malgun Gothic", sans-serif;
  }

  /* ë ˆì´ì•„ì›ƒ: ì¢Œ/ì¤‘/ìš° 3ë‹¨ â†’ ë°˜ì‘í˜•ì—ì„œ 2ë‹¨/1ë‹¨ìœ¼ë¡œ */
  .wrap{
    height:100vh; padding:16px; gap:18px;
    display:grid;
    grid-template-columns: 260px 1fr 380px;
    grid-template-areas: "left mid right";
  }
  .side { grid-area:left; }
  .mid  { grid-area:mid; }
  .right{ grid-area:right; }

  .side,.mid,.right{
    background:var(--panel); border:1px solid var(--line); border-radius:14px;
  }
  .side{padding:14px; display:flex; flex-direction:column; gap:12px;}
  .mid {padding:12px; display:flex; align-items:center; justify-content:center;}
  .right{display:flex; flex-direction:column;}

  .brand{display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.2px; padding:6px 8px; margin-bottom:6px}

  .nav{display:flex; flex-direction:column; gap:6px; margin-bottom:6px}
  .nav a{display:flex; align-items:center; gap:8px; color:var(--muted); padding:8px 10px; border-radius:10px; text-decoration:none}
  .nav a:hover{background:#181b24; color:var(--text)}

  .pillbar{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:2px}
  .pill{background:#171a22; border:1px solid var(--line); border-radius:12px; padding:10px; text-align:center; color:var(--muted); font-size:12px}

  .zone{border:1px dashed #3a3d46; background:#10131a; border-radius:12px; padding:10px; height:220px; display:flex; flex-direction:column; gap:8px}
  .zone h5{margin:0; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
  .square{flex:1; background:#0f1218; border-radius:10px; display:grid; place-items:center; overflow:hidden; position:relative}
  .square canvas,.square img{max-width:100%; max-height:100%; object-fit:contain}
  .muted{color:var(--muted); font-size:12px}

  .row{display:flex; gap:8px; flex-wrap:wrap}
  .btn{background:#1a1e28; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700}
  .btn.primary{background:linear-gradient(135deg,#588afc,#68e1ff); color:#091016; border:none}
  .btn:disabled{opacity:.55; cursor:not-allowed}

  .seg{display:flex; background:#171b25; border:1px solid var(--line); border-radius:12px; overflow:hidden}
  .seg button{flex:1; padding:8px 10px; background:transparent; color:var(--muted); border:none; cursor:pointer; font-weight:700}
  .seg button.active{background:#24324a; color:#eaf2ff}

  .checks{display:flex; gap:8px; flex-wrap:wrap}
  .chk{display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:#161a23}
  .chk input{accent-color:var(--accent)}

  .mid canvas{width:100%; height:100%; border-radius:10px}

  .r-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line)}
  .r-list{flex:1; overflow:auto; padding:12px 14px}
  .card{background:#141824; border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin-bottom:10px}
  .badge{display:inline-flex; align-items:center; gap:6px; color:#cbd5e1; background:#0f172a; border:1px solid #1f2937; border-radius:999px; padding:2px 8px; font-size:12px}
  .hint{color:#a8b0ba; font-size:12px; margin-top:6px}
  .foot{padding:10px 14px; border-top:1px solid var(--line); display:flex; gap:8px; align-items:center}
  .toggle{display:flex; align-items:center; gap:8px}
  .toggle input{accent-color:var(--accent)}
  .ghost{opacity:.7}
  .filebtn{font-size:11px; padding:4px 8px; border-radius:8px; border:1px solid var(--line); background:#1b1f29; color:var(--text); cursor:pointer}
  .drop{outline:2px dashed var(--accent-2)}

  /* TOD line íˆ´íŒ */
  .tip{position:relative; display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:700}
  .tip .box{border:1px dashed #3b4150; border-radius:10px; padding:8px 10px; background:#121620}
  .tip .pop{
    position:absolute; left:100%; top:0; margin-left:10px; z-index:5;
    min-width:160px; background:#0f1320; border:1px solid #283041; border-radius:10px; padding:8px 10px;
    display:none; color:#cbd5e1; font-size:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  .tip:hover .pop{display:block}
  .pop ul{margin:6px 0 0 16px; padding:0}
  .pop li{margin:2px 0}

  /* ë°˜ì‘í˜• */
  @media (max-width: 1280px){
    .wrap{
      grid-template-columns: 240px 1fr;
      grid-template-areas:
        "left mid"
        "left right";
    }
    .right{min-height:40vh}
  }
  @media (max-width: 840px){
    .wrap{
      grid-template-columns: 1fr;
      grid-template-areas:
        "left"
        "mid"
        "right";
      height:auto; min-height:100vh;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <aside class="side">
      <div class="brand">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 10l-4 4M5 19l3-7 7-7 4 4-7 7-7 3z" stroke="#88b6ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        TOD play
      </div>

      <nav class="nav">
        <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M3 6h18M3 18h18" stroke="#95a9c7" stroke-width="1.5"/></svg> ê°€ì´ë“œ</a>
        <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M10 20l-6-6 6-6" stroke="#95a9c7" stroke-width="1.5" stroke-linecap="round"/><path d="M20 20l-6-6 6-6" stroke="#95a9c7" stroke-width="1.5" stroke-linecap="round"/></svg> íƒìƒ‰</a>
        <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 4h12v16H6z" stroke="#95a9c7" stroke-width="1.5"/><path d="M6 10h12" stroke="#95a9c7" stroke-width="1.5"/></svg> êµ¬ë…</a>
        <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M6 7v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7" stroke="#95a9c7" stroke-width="1.5"/><path d="M9 7V5a3 3 0 0 1 6 0v2" stroke="#95a9c7" stroke-width="1.5"/></svg> ë¹„ì¦ˆë‹ˆìŠ¤</a>
      </nav>

      <div class="pillbar">
        <div class="pill">ìë£Œ ë°ì´í„° ì €ì¥ì†Œ<br><span class="muted">ìë£Œë¥¼ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</span></div>
        <div class="pill">í•™ìŠµ ë°ì´í„° ì €ì¥ì†Œ<br><span class="muted">í•™ìŠµ ì´ë ¥ì„ ì••ì¶•í•´ ë³´ê³ /ì¶œë ¥</span></div>
      </div>

      <!-- TOD line íˆ´íŒ ë°•ìŠ¤ -->
      <div class="tip">
        <div class="box">TOD line â“˜</div>
        <div class="pop">
          <div style="font-weight:700; margin-bottom:4px">ì„œë¸Œ ì œí’ˆêµ°</div>
          <ul>
            <li>TOD play â€” ì„ì˜ëŒ€ìƒ ëª¨ì‚¬/í”¼ë“œë°±</li>
            <li>TOD hero â€” ì»¤ë¦¬í˜ëŸ¼Â·ê°€ì´ë“œ</li>
            <li>TOD master â€” ì „ë¬¸ê°€ ë¦¬í¬íŠ¸</li>
            <li>TOD data â€” ë°ì´í„° ê´€ë¦¬</li>
          </ul>
        </div>
      </div>

      <div class="zone" id="zoneRef">
        <h5>ì›ë³¸ ì´ë¯¸ì§€ <button class="filebtn" onclick="pick('ref')">íŒŒì¼ ì„ íƒ</button></h5>
        <div class="square" id="squareRef"><span class="muted">ëŒì–´ì˜¤ê¸° ê°€ëŠ¥</span></div>
      </div>

      <div class="zone" id="zoneStu">
        <h5>ì‹¤ìŠµ ì´ë¯¸ì§€ <button class="filebtn" onclick="pick('stu')">íŒŒì¼ ì„ íƒ</button></h5>
        <div class="square" id="squareStu"><span class="muted">ëŒì–´ì˜¤ê¸° ê°€ëŠ¥</span></div>
      </div>

      <div>
        <div class="muted" style="margin:6px 0 4px">í•™ìŠµ ìœ í˜• ì„ íƒ</div>
        <div class="seg" id="modeSeg">
          <button data-mode="copy" class="active">ëª¨ì‘</button>
          <button data-mode="style">ìŠ¤íƒ€ì¼ ëª¨ì‘</button>
          <button data-mode="create">ì°½ì‘</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin:6px 0 4px">í‰ê°€ í•­ëª© ì„ íƒ</div>
        <div class="checks" id="aspects">
          <label class="chk"><input type="checkbox" checked value="shape"/> í˜•íƒœ</label>
          <label class="chk"><input type="checkbox" value="value"/> ëª…ì•”</label>
          <label class="chk"><input type="checkbox" value="color"/> ìƒ‰ê°</label>
          <label class="chk"><input type="checkbox" value="persp"/> íˆ¬ì‹œ</label>
          <label class="chk"><input type="checkbox" value="comp"/> êµ¬ë„</label>
        </div>
      </div>

      <button class="btn primary" id="runBtn">ë¶„ì„ ì‹œì‘</button>
      <div class="toggle hint">
        <input type="checkbox" id="normalize" checked>
        <label for="normalize">ê¸´ë³€ ê¸°ì¤€ ì •ê·œí™”(ìŠ¤ì¼€ì¼ ë™ê¸°í™”) ì ìš©</label>
      </div>
      <div class="toggle hint">
        <input type="checkbox" id="demoMode">
        <label for="demoMode">ë°ëª¨ ëª¨ë“œ(ë°±ì—”ë“œ ì—†ì´ ì‹œì—°)</label>
      </div>

      <!-- hidden inputs -->
      <input type="file" id="fileRef" accept="image/*" hidden />
      <input type="file" id="fileStu" accept="image/*" hidden />
    </aside>

    <!-- MIDDLE -->
    <main class="mid">
      <canvas id="canvas" width="1280" height="900"></canvas>
    </main>

    <!-- RIGHT -->
    <aside class="right">
      <div class="r-head">
        <div class="badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M21 12a8 8 0 1 1-3.1-6.3L21 5l-.9 2.9A8 8 0 0 1 21 12z" stroke="#9ec1ff" stroke-width="1.3"/>
          </svg>
          í”¼ë“œë°± ë¡œê·¸
        </div>
        <div class="ghost" style="font-size:12px">v0.2 MVP</div>
      </div>
      <div class="r-list" id="log"></div>
      <div class="foot">
        <span class="hint">ì˜ë¬¸ì ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì§ˆë¬¸í•˜ì„¸ìš”</span>
        <span style="margin-left:auto" class="ghost">ğŸ¤ ğŸ”Š</span>
      </div>
    </aside>
  </div>

<script>
  const API_BASE = "http://127.0.0.1:8000"; // FastAPI endpoint
  const canvas = document.getElementById('canvas');
  const ctx     = canvas.getContext('2d');

  const state = { mode:'copy', refImg:null, stuImg:null, refData:null, stuData:null };

  function el(id){return document.getElementById(id)}
  function log(msg, level='info'){
    const box = document.createElement('div');
    box.className = 'card';
    const colors = {info:'#cbd5e1', ok:'#86efac', warn:'#fde68a', err:'#fecaca'};
    box.innerHTML = `<div style="white-space:pre-wrap;color:${colors[level]||colors.info}">${msg}</div>`;
    el('log').prepend(box);
  }

  function pick(which){ el(which==='ref'?'fileRef':'fileStu').click(); }
  function readFile(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  async function setImage(which, dataURL){
    const img = new Image();
    img.onload = ()=>{
      state[which+'Img']=img; state[which+'Data']=dataURL;
      const sq = el(which==='ref'?'squareRef':'squareStu'); sq.innerHTML=''; const tag=document.createElement('img'); tag.src=img.src; sq.appendChild(tag);
      drawOverlay();
    };
    img.src = dataURL;
  }

  function drawOverlay(overlay=null){
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = '#0e1016'; ctx.fillRect(0,0,canvas.width, canvas.height);

    const pad=30, W=canvas.width-pad*2, H=canvas.height-pad*2;
    const normalize = el('normalize').checked;
    const ref=state.refImg, stu=state.stuImg;
    if(!ref && !stu) return;

    let rw=ref?.width||0, rh=ref?.height||0, sw=stu?.width||0, sh=stu?.height||0;

    function fit(w,h){ const r=Math.min(W/w, H/h); return {w:w*r,h:h*r}; }

    let refBox=null, stuBox=null;
    if(ref && stu && normalize){
      const rLong=Math.max(rw,rh), sLong=Math.max(sw,sh), target=Math.min(W,H);
      refBox={w:rw*(target/rLong), h:rh*(target/rLong)};
      stuBox={w:sw*(target/sLong), h:sh*(target/sLong)};
    }else{
      if(ref) refBox=fit(rw,rh);
      if(stu) stuBox=fit(sw,sh);
    }
    function center(b){return {x:pad+(W-b.w)/2, y:pad+(H-b.h)/2};}
    const rc=refBox?center(refBox):null, sc=stuBox?center(stuBox):null;

    if(stu){ ctx.globalAlpha=.8;  ctx.drawImage(stu, sc.x, sc.y, stuBox.w, stuBox.h); }
    if(ref){ ctx.globalAlpha=.55; ctx.drawImage(ref, rc.x, rc.y, refBox.w, refBox.h); }
    ctx.globalAlpha=1;

    if(overlay){
      const ov = new Image();
      ov.onload = ()=> ctx.drawImage(ov, rc?rc.x:pad, rc?rc.y:pad, rc?refBox.w:W, rc?refBox.h:H);
      ov.src = overlay;
    }
  }

  // DnD
  ['zoneRef','zoneStu'].forEach(id=>{
    const z=el(id);
    z.addEventListener('dragover', e=>{e.preventDefault(); z.classList.add('drop');});
    z.addEventListener('dragleave', ()=> z.classList.remove('drop'));
    z.addEventListener('drop', async e=>{
      e.preventDefault(); z.classList.remove('drop');
      const f=e.dataTransfer.files?.[0]; if(!f) return;
      await setImage(id==='zoneRef'?'ref':'stu', await readFile(f));
    });<!-- TEST: 123 -->

  });

  // File inputs
  el('fileRef').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; await setImage('ref', await readFile(f)); });
  el('fileStu').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; await setImage('stu', await readFile(f)); });

  // Mode segment
  document.getElementById('modeSeg').addEventListener('click', e=>{
    if(e.target.tagName!=='BUTTON') return;
    [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active'); state.mode=e.target.dataset.mode;
  });

  // Run
  el('runBtn').addEventListener('click', async ()=>{
    if(!state.stuData){ log("ì‹¤ìŠµ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ë„£ì–´ì£¼ì„¸ìš”.", 'warn'); return; }
    const aspects=[...document.querySelectorAll('#aspects input:checked')].map(i=>i.value);
    const payload={ mode:state.mode, aspects, normalize:el('normalize').checked, original:state.refData, practice:state.stuData };

    if(el('demoMode').checked){
      log("ë°ëª¨ ëª¨ë“œ: ë°±ì—”ë“œ í˜¸ì¶œ ì—†ì´ ìƒ˜í”Œ í”¼ë“œë°±ì„ í‘œì‹œí•©ë‹ˆë‹¤.");
      drawOverlay();
      mockFeedback(payload); return;
    }

    try{
      el('runBtn').disabled=true; el('runBtn').textContent="ë¶„ì„ ì¤‘â€¦";
      const r=await fetch(`${API_BASE}/analyze`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      if(data.overlay) drawOverlay(data.overlay);
      if(data.feedback?.length) data.feedback.forEach(t=>log("â€¢ "+t)); else log("í”¼ë“œë°± ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.", 'warn');
      if(data.stats) log("í‰ê°€ ì§€í‘œ: "+JSON.stringify(data.stats), 'info');
    }catch(err){
      log("ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” ì˜¤ë¥˜: "+err.message, 'err');
    }finally{
      el('runBtn').disabled=false; el('runBtn').textContent="ë¶„ì„ ì‹œì‘";
    }
  });

  // Demo feedback
  function mockFeedback({mode, aspects}){
    const common = [
      "ê¸´ë³€ ì •ê·œí™”ë¥¼ ì‚¬ìš©í•´ ë‘ ì´ë¯¸ì§€ì˜ ìŠ¤ì¼€ì¼ì„ ë§ì·„ìŠµë‹ˆë‹¤.",
      "ì „ì²´ ê· í˜•ì€ ì•ˆì •ì ì…ë‹ˆë‹¤. ì„¸ë¶€ ì •í•©ì„ ì¡°ê¸ˆë§Œ ë³´ì™„í•´ ë³´ì„¸ìš”."
    ];
    const lines=[];
    if(mode==='copy'){
      if(aspects.includes('shape')) lines.push("í˜•íƒœ: ì™¸ê³½ ì‹¤ë£¨ì—£ ìœ ì‚¬ë„ ë†’ìŒ. ì¢Œì¸¡ íŒ” ê°ë„ê°€ ì›ë³¸ ëŒ€ë¹„ 8Â° ë‚®ìŠµë‹ˆë‹¤.");
      if(aspects.includes('persp')) lines.push("íˆ¬ì‹œ: ë°œë°”ë‹¥ì„  ì†Œì‹¤ì ì´ ìƒí–¥ìœ¼ë¡œ 2% ì¹˜ìš°ì¹©ë‹ˆë‹¤.");
      if(aspects.includes('comp'))  lines.push("êµ¬ë„: ì‹œê° ì¤‘ì‹¬ì´ 12px ìš°ì¸¡â€”ì¤‘ì‹¬ì„  ë³´ì • ê¶Œì¥.");
    }else if(mode==='style'){
      if(aspects.includes('value')) lines.push("ëª…ì•”(ìŠ¤íƒ€ì¼): í•˜ì´ë¼ì´íŠ¸ ë²”ìœ„ê°€ ë„“ê³  ê²½ê³„ê°€ ë¶€ë“œëŸ¬ì›€â€”ì¤‘ê°„í†¤ 10~15% í™•ëŒ€.");
      if(aspects.includes('color')) lines.push("ìƒ‰ê°(ìŠ¤íƒ€ì¼): ì›ë³¸ì˜ ì°¨ê°€ìš´ ê·¸ë ˆì´ ëŒ€ë¹„ ë”°ëœ»í•œ í†¤ì´ ê°•í•¨â€”B -5 / S -8 ê¶Œì¥.");
    }else{
      lines.push("ì°½ì‘: í¬ì¦ˆ ë¦¬ë“¬ì„ í‚¤ìš°ë ¤ë©´ ì–´ê¹¨â€“ê³¨ë°˜ ì—­ê°ì„ 5Â° ì¦ê°€í•´ ë³´ì„¸ìš”.");
    }
    [...common, ...lines].forEach(t=>log("â€¢ "+t));
  }
</script>
</body>
</html>
