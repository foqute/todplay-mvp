<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1400, user-scalable=no" />
<title>TOD play â€“ Fixed MVP</title>
<style>
  /* ===== ê³ ì • ë ˆì´ì•„ì›ƒ ì¹˜ìˆ˜ ===== */
  :root{
    --w-sidenav: 120px;          /* ë§¨ ì™¼ìª½ ì„¸ë¡œ ë©”ë‰´ */
    --w-left:   360px;           /* ì—…ë¡œë“œ ë° ì˜µì…˜ íŒ¨ë„ */
    --w-right:  380px;           /* í”¼ë“œë°± íŒ¨ë„ */
    --gap:      24px;
    --stage-w:  990px;           /* ê°€ìš´ë° ì‘ì—… ìº”ë²„ìŠ¤ ê°€ë¡œ */
    --stage-h:  680px;           /* ê°€ìš´ë° ì‘ì—… ìº”ë²„ìŠ¤ ì„¸ë¡œ */
    --bg: #0e1217; --panel:#141a22; --panel2:#10151c; --txt:#dbe3ee; --muted:#96a2b3;
    --line:#2a3542; --line2:#334254; --blue:#2f7df4; --blue2:#4aa1ff; --chip:#1b2430; --chipOn:#2a3b51;
  }
  *{box-sizing:border-box} html,body{height:100%;background:var(--bg);color:var(--txt);margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .page{
    width: calc(var(--w-sidenav) + var(--w-left) + var(--gap) + var(--stage-w) + var(--gap) + var(--w-right));
    min-height: calc(var(--stage-h) + 120px);
    margin: 24px auto;
    display: grid;
    grid-template-columns: var(--w-sidenav) var(--w-left) var(--stage-w) var(--w-right);
    grid-template-rows: auto;
    column-gap: var(--gap);
    align-items: start;
  }
  .card{background:var(--panel); border:1px solid var(--line); border-radius:10px; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset}
  .label{display:block; font-weight:700; margin:10px 12px 6px; color:#cfe2ff}
  .sub{color:var(--muted); font-size:12px; margin:0 12px 10px}
  .btn{background:#1a2633; border:1px solid var(--line2); color:#eaf2ff; padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn.primary{background: linear-gradient(90deg, var(--blue), var(--blue2)); border:none; color:white; font-weight:700}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); border:1px solid var(--line2); padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none}
  .chip.on{background:var(--chipOn); border-color:#446086}
  .row{display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .hint{color:#9fb1c6; font-size:12px; text-align:center}

  /* ===== ì‚¬ì´ë“œ ë‚´ë¹„ ===== */
  .sidenav{grid-column:1; position:sticky; top:24px}
  .brand{display:flex; gap:8px; align-items:center; margin-bottom:14px; padding:10px; border-radius:10px}
  .brand img{width:22px; height:22px}
  .brand b{letter-spacing:.2px}
  .navbtn{display:block; width:100%; padding:10px 8px; margin-bottom:8px; background:var(--panel); border:1px solid var(--line); color:var(--txt); border-radius:10px; text-align:center; cursor:pointer}
  .navbtn:hover{border-color:#3b4a5f}

  /* ===== ì™¼ìª½ ì˜µì…˜ íŒ¨ë„ ===== */
  .left{grid-column:2; display:flex; flex-direction:column; gap:14px}
  .store, .learn{padding:10px 10px 12px}
  .drop{padding:12px}
  .dz{
    height:140px; background:var(--panel2); border:2px dashed #3a4a5e; border-radius:12px; display:grid; place-items:center; color:#b9c7d9
  }
  .dz input{display:none}
  .dz .dz-tip{pointer-events:none}
  .opts{padding:12px}
  .opts .grp{margin:8px 0 12px}
  .opts .grp .title{font-weight:700; margin-bottom:6px}
  .optrow{display:flex; gap:8px; flex-wrap:wrap}
  .radio{background:var(--chip); border:1px solid var(--line2); border-radius:8px; padding:6px 10px; cursor:pointer}
  .radio input{display:none}
  .radio.on{background:var(--chipOn); border-color:#466189}
  .run{margin-top:8px; display:flex; justify-content:stretch}
  .run .btn{flex:1; padding:12px}

  /* ===== ê°€ìš´ë° ìŠ¤í…Œì´ì§€(ê³ ì • í¬ê¸°) ===== */
  .stageWrap{grid-column:3; position:relative; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px}
  #stage{display:block; width:var(--stage-w); height:var(--stage-h); background:#fff; border-radius:12px}

  /* ===== ì˜¤ë¥¸ìª½ í”¼ë“œë°± íŒ¨ë„ ===== */
  .right{grid-column:4; display:flex; flex-direction:column; gap:10px}
  .right .hd{display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:var(--panel); border:1px solid var(--line)}
  .score{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:10px; min-height:44px}
  .notes{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px; min-height:360px; overflow:auto}
  .chat{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center}
  .chat input{flex:1; background:#0f151c; border:1px solid var(--line2); border-radius:8px; padding:10px; color:var(--txt)}
  .ico{width:36px; height:36px; border-radius:10px; background:#1a2430; border:1px solid var(--line2); color:#dbe6ff; display:grid; place-items:center; cursor:pointer}

  /* ì„¸ì„¸í•œ ë³´ì • */
  .ver{color:#9eb2c9; font-size:12px}
  .card-title{font-weight:700; margin:4px 0 8px 2px}
</style>
</head>
<body>

<div class="page">

  <!-- ì¢Œì¸¡ ì„¸ë¡œ ë©”ë‰´ -->
  <aside class="sidenav">
    <div class="brand">
      <img src="logo.png" alt="">
      <b>TOD play</b>
    </div>
    <button class="navbtn">ê°€ì´ë“œ</button>
    <button class="navbtn">íƒìƒ‰</button>
    <button class="navbtn">êµ¬ë…</button>
    <button class="navbtn">ë¹„ì¦ˆë‹ˆìŠ¤</button>
  </aside>

  <!-- ì—…ë¡œë“œ + ì˜µì…˜ íŒ¨ë„ -->
  <section class="left">

    <div class="card store">
      <span class="label">ìë£Œ ë°ì´í„° ì €ì¥ì†Œ</span>
      <p class="sub">ìë£Œë¥¼ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <div class="card learn">
      <span class="label">í•™ìŠµ ë°ì´í„° ì €ì¥ì†Œ</span>
      <p class="sub">í•™ìŠµìš© ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì…ë ¥í•´ ë¹ ë¥´ê²Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <div class="card drop" id="ref-box">
      <div class="card-title">ì›ë³¸ ì´ë¯¸ì§€</div>
      <label class="dz" id="ref-dz">
        <input id="ref" type="file" accept="image/*">
        <div class="dz-tip">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­<br>(ëŠì–´ì˜¤ê¸° ê°€ëŠ¥)</div>
      </label>
    </div>

    <div class="card drop" id="stu-box">
      <div class="card-title">ì‹¤ìŠµ ì´ë¯¸ì§€</div>
      <label class="dz" id="stu-dz">
        <input id="stu" type="file" accept="image/*">
        <div class="dz-tip">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­<br>(ëŠì–´ì˜¤ê¸° ê°€ëŠ¥)</div>
      </label>
    </div>

    <div class="card opts">
      <div class="grp">
        <div class="title">í•™ìŠµ ìœ í˜• ì„ íƒ</div>
        <div class="optrow" id="modes">
          <label class="radio on"><input type="radio" name="mode" value="copy" checked>ëª¨ì‘</label>
          <label class="radio"><input type="radio" name="mode" value="style">ìŠ¤íƒ€ì¼ ëª¨ì‘</label>
          <label class="radio"><input type="radio" name="mode" value="orig">ì°½ì‘</label>
        </div>
      </div>
      <div class="grp">
        <div class="title">í‰ê°€ í•­ëª© ì„ íƒ</div>
        <div class="chips" id="chips">
          <div class="chip on"  data-k="í˜•íƒœ">í˜•íƒœ</div>
          <div class="chip on"  data-k="ëª…ì•”">ëª…ì•”</div>
          <div class="chip"      data-k="ìƒ‰ê°">ìƒ‰ê°</div>
          <div class="chip"      data-k="íˆ¬ì‹œ">íˆ¬ì‹œ</div>
          <div class="chip"      data-k="êµ¬ë„">êµ¬ë„</div>
        </div>
      </div>
      <div class="run"><button id="btn-run" class="btn primary">ë¶„ì„ ì‹œì‘</button></div>
    </div>

  </section>

  <!-- ê°€ìš´ë° ìº”ë²„ìŠ¤(ê³ ì • í¬ê¸°) -->
  <section class="stageWrap card">
    <canvas id="stage" width="990" height="680"></canvas>
  </section>

  <!-- ì˜¤ë¥¸ìª½ í”¼ë“œë°± -->
  <aside class="right">
    <div class="hd">
      <div><b>í”¼ë“œë°± ë¡œê·¸</b></div>
      <div class="ver">v0.2 MVP</div>
    </div>
    <div id="score" class="score"></div>
    <div id="notes" class="notes">ì•„ì§ ë¶„ì„ì„ ì‹œì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê³  â€˜ë¶„ì„ ì‹œì‘â€™ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
    <div class="chat">
      <input id="ask" placeholder="ì˜ë¬¸ì ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì§ˆë¬¸í•˜ì„¸ìš”" />
      <div class="ico" title="ìŒì„±">ğŸ¤</div>
      <div class="ico" title="ì „ì†¡">â¤</div>
    </div>
  </aside>

</div>

<script>
/* ========== ì‘ì€ ìœ í‹¸ ========== */
const $ = s => document.querySelector(s);

/* ë¼ë””ì˜¤/ì¹© í† ê¸€ UI */
for (const r of document.querySelectorAll('.radio')) {
  r.addEventListener('click', () => {
    document.querySelectorAll('.radio').forEach(x=>x.classList.remove('on'));
    r.classList.add('on');
    r.querySelector('input').checked = true;
  });
}
for (const c of document.querySelectorAll('.chip')) {
  c.addEventListener('click', ()=>c.classList.toggle('on'));
}

/* ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë” */
function wireDrop(labelEl, inputEl){
  ['dragenter','dragover'].forEach(ev=>labelEl.addEventListener(ev, e=>{e.preventDefault();labelEl.style.borderColor='#66a3ff'}));
  ['dragleave','drop'].forEach(ev=>labelEl.addEventListener(ev, e=>{e.preventDefault();labelEl.style.borderColor='#3a4a5e'}));
  labelEl.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files?.[0];
    if(f){ inputEl.files = e.dataTransfer.files; }
  });
}
wireDrop($('#ref-dz'), $('#ref'));
wireDrop($('#stu-dz'), $('#stu'));

/* ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°(ì˜¤ë²„ë ˆì´ ë¯¸ë¦¬ë³´ê¸°ìš©) */
const stage = $('#stage'), ctx = stage.getContext('2d');
function drawOverlay(src){
  if(!src) return;
  const img = new Image();
  img.onload = ()=>{
    ctx.clearRect(0,0,stage.width,stage.height);
    // ê°€ìš´ë° ë§ì¶° contain
    const sw = stage.width, sh = stage.height;
    const rs = Math.min(sw/img.width, sh/img.height);
    const dw = Math.round(img.width*rs), dh = Math.round(img.height*rs);
    const dx = Math.floor((sw-dw)/2), dy = Math.floor((sh-dh)/2);
    ctx.drawImage(img, dx, dy, dw, dh);
  };
  img.src = src;
}

/* ë°±ì—”ë“œ ì—°ë™(ê¸°ì¡´ í¬ë§· ìœ ì§€) */
$('#btn-run').addEventListener('click', async ()=>{
  const score  = $('#score');
  const notes  = $('#notes');
  score.textContent = 'í‰ê°€ ì¤‘â€¦';

  // ì„ íƒê°’ ëª¨ìœ¼ê¸°
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const aspects = [...document.querySelectorAll('.chip.on')].map(c=>c.dataset.k);

  // íŒŒì¼
  const rf = $('#ref').files[0];
  const sf = $('#stu').files[0];
  if(!rf && !sf){ notes.textContent='ì›ë³¸/ì‹¤ìŠµ ì´ë¯¸ì§€ ì¤‘ ìµœì†Œ 1ê°œëŠ” ì„ íƒí•´ ì£¼ì„¸ìš”.'; score.textContent=''; return }

  // í¼
  const form = new FormData();
  if(rf) form.append('ref', rf, rf.name || 'ref.jpg');
  if(sf) form.append('stu', sf, sf.name || 'stu.jpg');
  form.append('mode', mode);
  form.append('aspects', JSON.stringify(aspects));

  try{
    const res = await fetch('http://127.0.0.1:8000/analyze', {method:'POST', body:form});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    // ì ìˆ˜ í•„ Pills
    score.innerHTML='';
    (data.scores||[]).forEach(s=>{
      const pill = document.createElement('span');
      pill.style.cssText='display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:999px;background:#1b2430;border:1px solid #2f3d52;font-weight:700';
      pill.textContent = `${s.name} ${Math.round(s.value)}ì `;
      score.appendChild(pill);
    });

    // í…ìŠ¤íŠ¸ í”¼ë“œë°±
    notes.innerHTML = (data.feedback||[]).map(t=>`<div style="margin:8px 0;padding:10px;border:1px solid #2b394b;border-radius:8px;background:#0f151c">${t}</div>`).join('') || 'í”¼ë“œë°± ì—†ìŒ';

    // ì˜¤ë²„ë ˆì´ ë¯¸ë¦¬ë³´ê¸°
    if(data.overlay){ drawOverlay(data.overlay); }

  }catch(e){
    console.warn(e);
    score.textContent='';
    notes.innerHTML = '<div class="muted">ë°±ì—”ë“œì— ì—°ê²°ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
  }
});
</script>
</body>
</html>
