<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TOD play â€¢ MVP</title>
  <style>
    /* ---------- ê¸°ë³¸ ---------- */
    :root{
      --bg:#0f1317;
      --panel:#151b20;
      --panel-2:#1b232b;
      --panel-3:#1f2831;
      --line:#2a3641;
      --line-strong:#3a4a58;
      --txt:#e7edf4;
      --txt-dim:#a7b3bf;
      --brand:#4ea8ff;
      --brand-2:#2d7fe6;
      --ok:#4cd4a8;
      --warn:#ffcf66;

      /* ë ˆì´ì•„ì›ƒ ë³€ìˆ˜ */
      --sidebar-w: clamp(240px, 18vw, 320px);
      --right-w: clamp(360px, 24vw, 460px);
      --gap: 16px;
      --radius: 10px;
      --shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      color:var(--txt); background:var(--bg);
    }
    a{color:inherit}
    .app{
      /* í™”ë©´ í­ì— ë”°ë¼ ìë™ í™•ì¥ + ì—¬ë°± ì¶•ì†Œ */
      max-width: 1920px;
      margin: 0 auto;
      padding: clamp(8px, 2vw, 18px);
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr var(--right-w);
      gap: var(--gap);
      min-height: 100dvh;
    }

    /* ---------- ì¢Œì¸¡ ì‚¬ì´ë“œ ---------- */
    .side{
      display:flex; flex-direction:column; gap:12px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; background:var(--panel); border:1px solid var(--line);
      border-radius:var(--radius);
    }
    .logo .dot{
      width:18px;height:18px; border-radius:50%;
      background:linear-gradient(135deg,var(--brand),#9bd0ff);
      box-shadow:0 0 0 2px rgba(78,168,255,.2);
    }
    .logo strong{font-weight:700; letter-spacing:.3px}

    .nav{
      display:grid; gap:8px;
    }
    .nav button{
      all:unset; display:flex; align-items:center; gap:10px;
      padding:10px 12px; background:var(--panel); border:1px solid var(--line);
      border-radius:var(--radius); cursor:pointer; color:var(--txt);
    }
    .nav button:hover{border-color:var(--line-strong); background:var(--panel-2)}
    .nav .ico{width:18px; text-align:center; opacity:.9}

    .card{
      background:var(--panel); border:1px solid var(--line);
      border-radius:var(--radius); padding:12px;
    }
    .card h6{margin:0 0 6px; font-size:12px; color:var(--txt-dim); font-weight:600; letter-spacing:.2px}
    .drop{
      margin-top:10px;
      background:#0d1115; border:1px dashed var(--line-strong);
      border-radius:8px; height:140px; display:grid; place-content:center; color:#cfd7df;
    }
    .drop input{display:none}
    .drop p{margin:0; font-size:12px; opacity:.9}
    .drop.drag{outline:2px solid var(--brand); outline-offset:2px}

    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chips label{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--panel-2); border:1px solid var(--line);
      border-radius:999px; padding:6px 10px; cursor:pointer;
    }
    .chips input{accent-color:var(--brand)}

    .run{
      position:sticky; bottom:0; margin-top:10px;
      background:var(--panel); border:1px solid var(--line); padding:10px; border-radius:var(--radius);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .btn{
      all:unset; cursor:pointer; background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff; padding:11px 18px; border-radius:10px; font-weight:700; letter-spacing:.2px;
      box-shadow:var(--shadow);
    }
    .btn:active{transform:translateY(1px)}

    /* ---------- ì¤‘ì•™ ìŠ¤í…Œì´ì§€ ---------- */
    .stage-wrap{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      padding: 14px; display:flex; align-items:center; justify-content:center;
      min-height: calc(100dvh - 120px);   /* í™”ë©´ ë†’ì´ì— ë§ì¶° ì»¤ì§ */
    }
    .stage{
      width: min(1200px, 100%);
      /* ì •ì‚¬ê°~ê°€ë¡œ ì§ì‚¬ê° ëª¨ë‘ ìœ ì—° Â· ì„¸ë¡œë„ ìµœëŒ€í•œ ì±„ì›€ */
      aspect-ratio: 16/10;
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    canvas{width:100%; height:100%; display:block; background:#fff}

    /* ---------- ìš°ì¸¡ í”¼ë“œë°± ---------- */
    .right{
      display:grid; grid-template-rows:auto 1fr auto; gap:10px;
    }
    .score{
      background:var(--panel); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; display:flex; justify-content:space-between; gap:8px;
    }
    .score b{color:#fff}
    .log{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      padding:12px; overflow:auto;
    }
    .chat{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      padding:8px; display:flex; gap:8px; align-items:center;
    }
    .chat input{
      flex:1 1 auto; background:var(--panel-3); border:1px solid var(--line);
      border-radius:8px; color:var(--txt); padding:10px 12px;
    }
    .icon-btn{
      all:unset; width:36px; height:36px; display:grid; place-content:center;
      border-radius:10px; cursor:pointer; background:var(--panel-3); border:1px solid var(--line);
      color:var(--txt-dim);
    }
    .icon-btn:hover{border-color:var(--line-strong); color:#fff}

    /* ---------- ë°˜ì‘í˜• ---------- */
    @media (max-width: 1280px){
      :root{ --sidebar-w: 260px; --right-w: 380px; }
      .stage{ aspect-ratio: 4/3; } /* ì°½ì´ ì‘ì•„ì§€ë©´ ì¡°ê¸ˆ ë” ì„¸ë¡œí˜• */
    }
    @media (max-width: 1024px){
      .app{
        grid-template-columns: 1fr; grid-template-rows: auto auto auto;
      }
      .side, .right{order:1}
      .stage-wrap{order:2}
      .right{order:3}
      .stage{width:100%; aspect-ratio: 3/2;}
    }

    /* ---------- ì˜¤ë²„ë ˆì´ ì •ë ¬(ì„ íƒ) ---------- */
    body.overlay::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background: center/contain no-repeat var(--ui-overlay, none);
      opacity:.22; mix-blend-mode:screen; z-index:9999;
    }
    .overlay-toggle{
      position:fixed; top:10px; right:calc(var(--right-w) + 24px);
      z-index:10000; display:flex; gap:8px; align-items:center;
      background:rgba(20,25,30,.6); border:1px solid var(--line); padding:6px 8px; border-radius:10px;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .overlay-toggle input[type="file"]{display:none}
    .overlay-toggle label, .overlay-toggle button{
      all:unset; padding:6px 10px; background:var(--panel-3); border:1px solid var(--line);
      border-radius:8px; cursor:pointer; color:#cfe2f5;
    }
    .overlay-toggle label:hover, .overlay-toggle button:hover{border-color:var(--line-strong); color:#fff}
  </style>
</head>
<body>
  <!-- ì˜¤ë²„ë ˆì´ ì •ë ¬ ë„ìš°ë¯¸(ì„ íƒ) -->
  <div class="overlay-toggle">
    <label for="ov-file">ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€</label>
    <button id="ov-toggle">í‘œì‹œ/ìˆ¨ê¹€</button>
    <input id="ov-file" type="file" accept="image/*">
  </div>

  <main class="app">
    <!-- ì¢Œì¸¡ -->
    <aside class="side">
      <div class="logo">
        <span class="dot" aria-hidden="true"></span>
        <strong>TOD play</strong>
      </div>

      <nav class="nav" aria-label="ê¸°ë³¸ ë©”ë‰´">
        <button><span class="ico">ğŸ“˜</span>ê°€ì´ë“œ</button>
        <button><span class="ico">ğŸ§­</span>íƒìƒ‰</button>
        <button><span class="ico">ğŸ“°</span>êµ¬ë…</button>
        <button><span class="ico">ğŸ’¼</span>ë¹„ì¦ˆë‹ˆìŠ¤</button>
      </nav>

      <section class="card">
        <h6>ìë£Œ ë°ì´í„° ì €ì¥ì†Œ</h6>
        <div class="drop" data-ref>
          <input type="file" id="ref" accept="image/*" />
          <p>íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­<br>(ëŒì–´ì˜¤ê¸° ê°€ëŠ¥)</p>
        </div>
      </section>

      <section class="card">
        <h6>í•™ìŠµ ë°ì´í„° ì €ì¥ì†Œ</h6>
        <div class="drop" data-stu>
          <input type="file" id="stu" accept="image/*" />
          <p>íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­<br>(ëŒì–´ì˜¤ê¸° ê°€ëŠ¥)</p>
        </div>
      </section>

      <section class="card">
        <h6>í•™ìŠµ ìœ í˜• ì„ íƒ</h6>
        <div class="chips" id="mode">
          <label><input type="radio" name="mode" value="copy" checked> ëª¨ì‘</label>
          <label><input type="radio" name="mode" value="style"> ìŠ¤íƒ€ì¼ ëª¨ì‘</label>
          <label><input type="radio" name="mode" value="solo"> ì°½ì‘</label>
        </div>
      </section>

      <section class="card">
        <h6>í‰ê°€ í•­ëª© ì„ íƒ</h6>
        <div class="chips" id="aspects">
          <label><input type="checkbox" value="í˜•íƒœ" checked> í˜•íƒœ</label>
          <label><input type="checkbox" value="ëª…ì•”" checked> ëª…ì•”</label>
          <label><input type="checkbox" value="ìƒ‰ê°"> ìƒ‰ê°</label>
          <label><input type="checkbox" value="íˆ¬ì‹œ"> íˆ¬ì‹œ</label>
          <label><input type="checkbox" value="êµ¬ë„"> êµ¬ë„</label>
        </div>
      </section>

      <div class="run">
        <small style="color:var(--txt-dim)">ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</small>
        <button id="btn-run" class="btn">ë¶„ì„ ì‹œì‘</button>
      </div>
    </aside>

    <!-- ì¤‘ì•™ -->
    <section class="stage-wrap">
      <div class="stage">
        <canvas id="stage" width="1600" height="1000" aria-label="ì˜¤ë²„ë ˆì´ ì¶œë ¥ ìº”ë²„ìŠ¤"></canvas>
      </div>
    </section>

    <!-- ìš°ì¸¡ -->
    <aside class="right">
      <div class="score"><div>í‰ê°€ ì ìˆ˜ â€¢</div><b id="score">-</b><span style="opacity:.6">v0.2 MVP</span></div>
      <div id="notes" class="log">
        ì•„ì§ ë¶„ì„ì„ ì‹œì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê³  â€˜ë¶„ì„ ì‹œì‘â€™ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
      </div>
      <div class="chat">
        <input id="q" type="text" placeholder="ì˜ë¬¸ì ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì§ˆë¬¸í•˜ì„¸ìš”" />
        <button class="icon-btn" title="ë§ˆì´í¬(í‘œì‹œìš©)">ğŸ¤</button>
        <button class="icon-btn" title="ìŒì„± ì‘ë‹µ(í‘œì‹œìš©)">ğŸ”Š</button>
      </div>
    </aside>
  </main>

  <script>
    /* ===== ë“œë¡­ì¡´ & ë¯¸ë¦¬ë³´ê¸° ===== */
    function mountDrop(zone){
      const input = zone.querySelector('input');
      zone.addEventListener('click',()=>input.click());
      zone.addEventListener('dragover',e=>{e.preventDefault(); zone.classList.add('drag')});
      zone.addEventListener('dragleave',()=>zone.classList.remove('drag'));
      zone.addEventListener('drop',e=>{
        e.preventDefault(); zone.classList.remove('drag');
        if(e.dataTransfer.files?.[0]) input.files = e.dataTransfer.files;
      });
    }
    document.querySelectorAll('.drop').forEach(mountDrop);

    /* ===== ë¶„ì„ ë²„íŠ¼ â†’ ë°±ì—”ë“œ ì—°ë™ ===== */
    const btnRun = document.getElementById('btn-run');
    const scoreEl = document.getElementById('score');
    const notes = document.getElementById('notes');
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');

    async function toBlobUrl(input){
      if(!input?.files?.[0]) return null;
      const file = input.files[0];
      return URL.createObjectURL(file);
    }

    btnRun.addEventListener('click', async ()=>{
      const refInput = document.getElementById('ref');
      const stuInput = document.getElementById('stu');

      const refUrl = await toBlobUrl(refInput);
      const stuUrl = await toBlobUrl(stuInput);

      const form = new FormData();
      if(refInput.files[0]) form.append('ref', refInput.files[0], 'ref.jpg');
      if(stuInput.files[0]) form.append('stu', stuInput.files[0], 'stu.jpg');
      // ëª¨ë“œ & í•­ëª©
      const mode = document.querySelector('input[name="mode"]:checked')?.value ?? 'copy';
      form.append('mode', mode);
      const aspects = [...document.querySelectorAll('#aspects input:checked')].map(i=>i.value);
      form.append('aspects', JSON.stringify(aspects));

      notes.innerHTML = '<div>ë¶„ì„ ìš”ì²­ ì¤‘â€¦</div>';

      try{
        const res = await fetch('http://127.0.0.1:8000/analyze', {method:'POST', body:form});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        // ì ìˆ˜ & ë¬¸ì¥
        scoreEl.textContent = (data.score ?? '-');
        notes.innerHTML = '';
        (data.scores || []).forEach(s=>{
          const p = document.createElement('div');
          p.style.marginBottom = '10px';
          p.innerHTML = `<b>${s.name}</b> : ${s.value}`;
          notes.appendChild(p);
        });
        if(data.feedback){
          const div = document.createElement('div');
          div.style.marginTop = '12px';
          div.innerHTML = data.feedback;
          notes.appendChild(div);
        }

        // ì˜¤ë²„ë ˆì´
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(data.overlay){
          const img = new Image();
          img.onload = ()=>{
            // ìº”ë²„ìŠ¤ì— ë§ê²Œ ìµœëŒ€í•œ í¬ê²Œ(ê°€ìš´ë° ì •ë ¬)
            const sx = canvas.width / img.width;
            const sy = canvas.height / img.height;
            const s = Math.min(sx, sy);
            const w = img.width * s, h = img.height * s;
            const dx = (canvas.width - w)/2, dy = (canvas.height - h)/2;
            ctx.drawImage(img, dx, dy, w, h);
          };
          img.src = data.overlay;
        }else{
          // ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°ë¼ë„ ë³´ì—¬ì£¼ê¸°
          const img = new Image();
          img.onload = ()=>{
            const s = Math.min(canvas.width/img.width, canvas.height/img.height);
            const w = img.width*s, h = img.height*s;
            ctx.drawImage(img, (canvas.width-w)/2, (canvas.height-h)/2, w, h);
          };
          img.src = stuUrl || refUrl || '';
        }
      }catch(err){
        console.warn(err);
        notes.innerHTML = '<div style="color:#ffb4b4">ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    });

    /* ===== ì˜¤ë²„ë ˆì´ ì •ë ¬ ë„ìš°ë¯¸ =====
       1) /frontend í´ë”ì— ë‹¹ì‹ ì˜ ì´ˆì•ˆ ì´ë¯¸ì§€ë¥¼ ë„£ê³  ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ
       2) [í‘œì‹œ/ìˆ¨ê¹€]ì„ ëˆŒëŸ¬ ë°°ê²½ì— ê²¹ì³ ë³´ë©´ì„œ í”½ì…€ ë‹¨ìœ„ êµì •
    */
    const ovToggle = document.getElementById('ov-toggle');
    const ovFile   = document.getElementById('ov-file');
    let overlayOn = false;

    ovToggle.addEventListener('click', ()=>{
      overlayOn = !overlayOn;
      document.body.classList.toggle('overlay', overlayOn);
    });
    ovFile.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      document.documentElement.style.setProperty('--ui-overlay', `url("${url}")`);
      if(!overlayOn){ overlayOn = true; document.body.classList.add('overlay'); }
    });
  </script>
</body>
</html>
